---
title: "ggPlot Your Data"
output: html_document
runtime: shiny
---


```{r, echo=FALSE ,warning=FALSE,error=FALSE }
suppressMessages (library(shiny))
suppressMessages (library(ggplot2))
suppressMessages (library(scales))
suppressMessages (library(DT))
suppressMessages (library(quantreg))
suppressMessages (library(Hmisc))
suppressMessages (library(quantreg))


stat_sum_df <- function(fun, geom="point", ...) {
  stat_summary(fun.data=fun,  geom=geom,  ...)
}
stat_sum_single <- function(fun, geom="point", ...) {
  stat_summary(fun.y=fun,  geom=geom,  ...)
}
options(shiny.maxRequestSize=200*1024^2) 



ui  <-  fluidPage(
    titlePanel("Hello User!"),
    sidebarLayout(

      sidebarPanel(
        tabsetPanel(
        tabPanel("Inputs", 
                      tagList(
      singleton(tags$head(tags$script(src='//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js',
                                      type='text/javascript'))),
      singleton(tags$head(tags$script(src='//cdn.datatables.net/tabletools/2.2.4/js/dataTables.tableTools.min.js',
type='text/javascript'))),
      singleton(tags$head(tags$script(src='//cdn.datatables.net/colreorder/1.1.3/js/dataTables.colReorder.min.js',type='text/javascript'))),
      singleton(tags$head(tags$script(src='colvis.js',type='text/javascript'))),
      singleton(tags$head(tags$script(src='//cdn.datatables.net/tabletools/2.2.4/js/ZeroClipboard.min.js',type='text/javascript'))),
      singleton(tags$head(tags$link(href='//cdn.datatables.net/tabletools/2.2.4/css/dataTables.tableTools.css',rel='stylesheet',type='text/css'))),
      singleton(tags$script(HTML("if (window.innerHeight < 400) alert('Screen too small');"))),
    tags$head( tags$style(HTML("
                        .cvclear{
                         text-align:right}"))) 
    ),
    
        #checkboxInput('example', 'Use Example Data',value=TRUE),

fileInput("datafile", "Choose csv file to upload", multiple = FALSE, accept = c("csv")),
                             
                             uiOutput("ycol"),
                             uiOutput("slider2"),
                             uiOutput("xcol"),
                             uiOutput("slider"),
                             uiOutput("maxlevels"),
tabsetPanel(
        tabPanel("Filters", 
                             uiOutput("filtervar1"),
                             uiOutput("filtervar1values"),
                             uiOutput("filtervar2"),
                             uiOutput("filtervar2values")
                 ),
        tabPanel("Categorize", 
        
                             uiOutput("catvar"),
                             uiOutput("ncuts"),
                             uiOutput("catvar2"))
        )
,
    hr()
          ), # tabpanel

tabPanel("Graph Options",
checkboxInput('logy', 'Log Y axis', value = FALSE) ,
checkboxInput('logx', 'Log X axis', value = FALSE) ,
textInput('ylab', 'Y axis label', value = "") ,
textInput('xlab', 'X axis label', value = "") ,



     selectInput('backgroundcol', label ='Background Color',
                 choices=c("Gray" ="gray97","White"="white","Dark Gray"="grey90"),
                 multiple=FALSE, selectize=TRUE,selected="gray97"),
    selectInput('legendposition', label ='Legend Position',
                 choices=c("left", "right", "bottom", "top"),
                 multiple=FALSE, selectize=TRUE,selected="bottom"),

selectInput('facetscales','Facet Scales:',c("fixed","free_x","free_y","free")),
selectInput('facetspace' ,'Facet Spaces:',c("fixed","free_x","free_y","free")),
h4("Reference Lines ?"),
    checkboxInput('identityline', 'Identity Line')    ,   
    checkboxInput('horizontalzero', 'Horizontol Zero Line'),
    checkboxInput('customline1', 'Vertical Line'),
 conditionalPanel(
                 condition = "input.customline1" , 

   numericInput("vline",label = "",value = 1) )

,
    checkboxInput('customline2', 'Horizontal Line'),
 conditionalPanel(
                 condition = "input.customline2" , 

   numericInput("hline",label = "",value = 1) ),
h4("Additional Themes Options ?"),
    checkboxInput('themebw', 'Use ggplot Black and White Theme ?')   , 
    checkboxInput('themeaspect', 'Use custom aspect ratio ?')   ,  
 conditionalPanel(
                 condition = "input.themeaspect" , 

   numericInput("aspectratio",label = "Y/x ratio",value = 1) ),


    checkboxInput('sepguides', 'Separate Legend Guides for Median/PI ?',value = TRUE),       
    checkboxInput('labelguides', 'Hide the Names of the Guides ?',value = FALSE)       



),

        tabPanel("How To",
                 h5("1. Upload your data file in CSV format. R default options for read.csv will apply except for missing values where both NA and dot . are treated as missing. If your data has columns with other non-numeric missing value codes then they be treated as factors."),
                 h5("2. It is assumed that your data is ready for ggplot (long format)."),                            h5("3. x and y variables input allow numeric and factor variables."),
                 h5("4. Sliders for x and y variables appear only for numeric variables."),  
                 h5("5. For more than one y variable stack your data first (using tidyr gather or similar). Then you can use values for y variable and your variable identifier for facetting. You might also want to use Facet Scales: free_x or free_y in the Graph Options tab."),
                 h5("6. The UI is dynamic and changes depending on your choices of options, x ,y, filter, group and so on."),
                 h5("7. There is two slots for Filter variables. Use these to apply exclusions on your data."),
                 h5("8. Filter variable 2 is applied after filter variable 1. Values shown for filter variable 2 will depend on your previous data exclusions via x/y sliders or filter variable 1."),

                 h5("9. If you want to change a numerical variable to categorical include it in the list of Categorical variables and then choose a number of cuts (default is 3). This helps when you want to group or color by cuts of a continuous variable."),
                 h5("10. You can simply change a numeric variable to factor without binning in the treat as categories slot."),
                 h5("11. Download the plot using the options on the 'Download' tab. This section is based on code from Mason DeCamillis ggplotLive app."),
                 h5("12. Visualize the data table in the 'Data' tab. You can reorder the columns, filter and much more."),
                p(),
                 h5("Samer Mouksassi 2015"),
               h5("Contact me @ samermouksassi@gmail.com for feedback/Bugs/features requests!")

                 )# tabpanel 
        )
      ), #sidebarPanel
      mainPanel(
        tabsetPanel(
          tabPanel("Plot"  , 
                    
               plotOutput('plot',  width = "100%" ,click = "plot_click",
                             hover = hoverOpts(id = "plot_hover", delayType = "throttle"),
                       brush = brushOpts(id = "plot_brush")),
               
                    #verbatimTextOutput("plotinfo"),
                hr(),
                       uiOutput("clickheader"),
             tableOutput("plot_clickedpoints"),
                       uiOutput("brushheader"),
             tableOutput("plot_brushedpoints"),
              

#actionButton("plotButton", "Update Plot"),
                  
          uiOutput("optionsmenu") ,
                
                conditionalPanel(
                 condition = "input.showplottypes" , 
                 
                 fluidRow(
                           
                     column (12, hr()),
                     column (3,
                             radioButtons("Points", "Points/Jitter:",
                                          c("Points" = "Points",
                                            "Jitter" = "Jitter",
                                            "None" = "None")),
                             conditionalPanel( " input.Points== 'Points' ",
sliderInput("pointstransparency", "Points Transparency:", min=0, max=1, value=c(0.5),step=0.01))
                             ),
                     column(3,
                     conditionalPanel( " input.Points== 'Points' ",
sliderInput("pointsizes", "Points Size:", min=0, max=4, value=c(1),step=0.1),
numericInput('pointtypes','Points Type:',16, min = 1, max = 25)
)),
                     
                      column (3,
                          
                             radioButtons("line", "Lines:",
                                          c("Lines" = "Lines",
                                             "None" = "None"),selected="None"),
                             conditionalPanel( " input.line== 'Lines' ",
                                               sliderInput("linestransparency", "Lines Transparency:", min=0, max=1, value=c(0.5),step=0.01)
                             
                             
                             )
                             
                             ),
column(3, conditionalPanel( " input.line== 'Lines' ",
                           sliderInput("linesize", "Lines Size:", min=0, max=4, value=c(1),step=0.1),
                           selectInput('linetypes','Lines Type:',c("solid","dotted"))

                           ) ),
column (12, h6("Points and Lines Size will apply only if Size By: in the Color Group Split Size Fill options are set to None"))
           
                     )#fluidrow
                 ) ,
      conditionalPanel(
                 condition = "input.showfacets" , 
                     fluidRow(
                     column (12, hr()),
                     column (3, uiOutput("colour"),uiOutput("group")),
                     column(3, uiOutput("facet_col"),uiOutput("facet_row")),
                     column (3, uiOutput("pointsize"),uiOutput("fill"))
                   )
                 ),
                 


 
#rqss quantile regression
conditionalPanel(
                 condition = "input.showrqss" , 

fluidRow(
  column(12,hr()),
  column(3,
      checkboxInput('Tauvalue', 'Dynamic and Preset Quantiles', value = FALSE),
      h5("Preset Quantiles"),
      checkboxInput('up', '95%'),
      checkboxInput('ninetieth', '90%'),
      checkboxInput('mid', '50%', value = FALSE),
      checkboxInput('tenth', '10%'),
      checkboxInput('low', '5%')
),
  column(5,
         sliderInput("Tau", label = "Dynamic Quantile Value:",
              min = 0, max = 1, value = 0.5, step = 0.01)  ,
          sliderInput("Penalty", label = "Spline sensitivity adjustment:",
              min = 0, max = 10, value = 1, step = 0.1)  ,
            selectInput("Constraints", label = "Spline constraints:",
              choices = c("N","I","D","V","C","VI","VD","CI","CD"), selected = "N")
  ),
  column(3,
checkboxInput('ignorecolqr', 'Ignore Color Above'),
checkboxInput('ignoregroupqr', 'Ignore Group Above',value = TRUE),
checkboxInput('hidedynamic', 'Hide Dynamic Quantile'),
selectInput('colqr', label ='QR Color', choices=colors(),multiple=FALSE, selectize=TRUE,selected="black")
      )

                      )#fluidrow
                   ),

conditionalPanel(
                 condition = "input.showLoess" , 

fluidRow(
  column(12,hr()),
  column (3, 
                                              radioButtons("Loess", "Loess:",
                                          c("Loess" = "Loess",
                                            "Loess and SE" = "Loess and SE",
                                            "None" = "None"),selected="None")
          ),
  column (3, 
          sliderInput("loessens", "Loess Span:", min=0, max=1, value=c(0.75),step=0.05)
             ),
  column (3, checkboxInput('ignorecol', 'Ignore Color Above'),
uiOutput("weight")
           
          ),
    column (3,checkboxInput('ignoregroup', 'Ignore Group Above',value = TRUE),
                selectInput('colloess', label ='Loess Color', choices=colors(),multiple=FALSE, selectize=TRUE,selected="black")
                        )
                      )#fluidrow
                   )
,

   conditionalPanel(
                 condition = "input.showMean" , 
                 
fluidRow(
  column(12,hr()),
  column (3, 
           radioButtons("Mean", "Mean:",
                       c("Mean" = "Mean",
                         "Mean (95% CI)" = "Mean (95% CI)",
                         "None" = "None") ,selected="None") 
          ),
 column (3,checkboxInput('meanpoints', 'Show points') ,
           checkboxInput('meanlines', 'Show lines') 
        # ,sliderInput("meansize", "Line Size:", min=0, max=3, value=1,step=0.05)
         )
 ,

    column (3,checkboxInput('meanignorecol', 'Ignore Color above') ,
           
         numericInput( inputId = "errbar",label = "CI bar width:",value = 2,min = 1,max = NA)
                        ),
 
 column(3,  checkboxInput('meanignoregroup', 'Ignore Group above',value = TRUE) ,
        selectInput('colmean', label ='Mean Color', choices=colors(),multiple=FALSE, selectize=TRUE,selected="black")
        )
                      ) #fluidrow
), # conditional panel for mean

### median PI section


   conditionalPanel(
                 condition = "input.showMedian" , 
fluidRow(
  column(12,hr()),
  column (3, 
                                            radioButtons("Median", "Median:",
                                          c("Median" = "Median",
                                            "Median/PI" = "Median/PI",
                                            "None" = "None") ,selected="None") 
          ),
   column (3,
  conditionalPanel( " input.Median== 'Median' ",
       checkboxInput('medianpoints', 'Show points') ,
           checkboxInput('medianlines', 'Show lines')),
    conditionalPanel( " input.Median== 'Median/PI' ",
          sliderInput("PI", "PI %:", min=0, max=1, value=c(0.95),step=0.01),
 sliderInput("PItransparency", "PI Transparency:", min=0, max=1, value=c(0.2),step=0.01)
          
)

  ) ,
   
    column (3,
              conditionalPanel( " input.Median!= 'None' ",
         checkboxInput('medianignorecol', 'Ignore Color Above'),
         conditionalPanel( " input.medianignorecol ",
             selectInput('colmedian', label ='Median Color', choices=colors(),multiple=FALSE, selectize=TRUE,selected="black") )

                       ) ),
  column (3,
                        conditionalPanel( " input.Median!= 'None' ",

         checkboxInput('medianignoregroup', 'Ignore Group Above',value = TRUE),
         sliderInput("medianlinesize", "Median Lines Size:", min=0, max=4, value=c(1),step=0.1)

                        )
                        )
  
                      )#fluidrow
)
### median PI section

          ),#tabPanel1
          tabPanel("Download", 
                     selectInput(
                     inputId = "downloadPlotType",
                     label   = h5("Select download file type"),
                     choices = list("PDF"  = "pdf","BMP"  = "bmp","JPEG" = "jpeg","PNG"  = "png")),
                   
                   # Allow the user to set the height and width of the plot download.
                   h5(HTML("Set download image dimensions<br>(units are inches for PDF, pixels for all other formats)")),
                     numericInput(
                     inputId = "downloadPlotHeight",label = "Height (inches)",value = 7,min = 1,max = 100),
                     numericInput(
                     inputId = "downloadPlotWidth",label = "Width (inches)",value = 7,min = 1,max = 100),
                           # Choose download filename.
                   textInput(
                     inputId = "downloadPlotFileName",
                     label = h5("Enter file name for download")),
                   
                   # File downloads when this button is clicked.
                   downloadButton(
                     outputId = "downloadPlot", 
                     label    = "Download Plot")
          ),
          
          tabPanel('Data',  dataTableOutput("mytablex") 
          )#tabPanel2
        )#tabsetPanel
         )#mainPanel
    )#sidebarLayout
  )#fluidPage
  

server <-  function(input, output, session) {
filedata <- reactive({
    infile <- input$datafile
    if (is.null(infile)) {
      # User has not uploaded a file yet
      return(NULL)
    }
    read.csv(infile$datapath,na.strings = c("NA","."))
  })
      
    

myData <- reactive({
    df=filedata()
    if (is.null(df)) return(NULL)
})
    
output$optionsmenu <-  renderUI({
  df <-filedata()
    if (is.null(df)) return(NULL)
  
             fluidRow(
             
                        hr(),
                      
                      column(4,checkboxInput('showplottypes', 'Plot types, Points, Lines (Options ?)', value = TRUE)),
                      column(4,checkboxInput('showfacets', 'Color Group Split Size Fill (Options ?)', value = TRUE) ),
                      column(4,checkboxInput('showrqss', 'Quantire Regresssion (Options ?)', value = TRUE)),
                      
                      column(4,checkboxInput('showLoess', 'Loess SE (Options ?)', value = TRUE)),
                      column(4,checkboxInput('showMean' , 'Mean CI (Options ?)', value = FALSE)),
                      
                      column(4,checkboxInput('showMedian','Median PIs (Options ?)', value = FALSE))
                      )
 })

output$xcol <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    
    items=names(df)
    names(items)=items
    selectInput("x", "x variable:",items)
    
  })
  
  output$ycol <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("y", "y variable:",items)
    
  })
        
output$slider <- renderUI({
    df <-filedata()
    xvariable<- input$x
    if (is.null(df)) return(NULL)
    if (!is.numeric(df[,xvariable]) ) return(NULL)
    
    sliderInput("inSlider", paste(xvariable,"Range"),
                min=min(df[,xvariable],na.rm=T),
                max=max(df[,xvariable],na.rm=T),
                value=c(min(df[,xvariable],na.rm=T),max(df[,xvariable],na.rm=T)) 
    )
                
  })


output$slider2 <- renderUI({
    df <-filedata()
    yvariable<- input$y
    if (is.null(df)) return(NULL)
    if (!is.numeric(df[,yvariable]) ) return(NULL)
  sliderInput("inSlider2", paste(yvariable,"Range"),
                min=min(df[,yvariable],na.rm=T),
                max=max(df[,yvariable],na.rm=T),
                value=c(min(df[,yvariable],na.rm=T),max(df[,yvariable],na.rm=T)) 
    )
  })



 output$maxlevels <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    numericInput( inputId = "inmaxlevels",label = "Max number of unique values for filter variables:",value = 250,min = 1,max = NA)
    
 })


 output$filtervar1 <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
   NUNIQUEDF <- sapply(df, function(x) length(unique(x)))
   NAMESTOKEEP<- names(df)  [ NUNIQUEDF  < input$inmaxlevels ]
   selectInput("infiltervar1" , "Filter variable 1:",c('None',NAMESTOKEEP ) )
      })
 
  output$filtervar1values <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
 if(input$infiltervar1=="None") {
return(NULL)  
                                }
 if(input$infiltervar1!="None" )  {
choices <- levels(as.factor(df[,input$infiltervar1]))
selectInput('infiltervar1valuesnotnull',
label = paste("Select values", input$infiltervar1),
choices = c(choices),
selected = choices,
multiple=TRUE, selectize=FALSE)   
}
  })  
        
subsetdata  <- reactive({
    df <- filedata()
    if (is.null(df)) return(NULL)
      if(!is.numeric( input$inSlider[1]) ) {
           df 
    }
    
    if(!is.numeric( input$inSlider2[1]) ) {
           df 
    }
    
    
    if(is.numeric( input$inSlider[1]) & is.numeric(df[,input$x])) {
            df<- df [!is.na(df[,input$x]),]

           df <-  df [df[,input$x] >= input$inSlider[1]&df[,input$x] <= input$inSlider[2],]

    }
    
    if(is.numeric( input$inSlider2[1])& is.numeric(df[,input$y]) ) {
      df<- df [!is.na(df[,input$y]),]
      
          df <-  df [df[,input$y] >= input$inSlider2[1]&df[,input$y] <= input$inSlider2[2],]

    }  
    
    if(is.null(input$infiltervar1)) {

          df <-  df 
    }
    
    
    if(!is.null(input$infiltervar1)&input$infiltervar1!="None") {

          df <-  df [ is.element(df[,input$infiltervar1],input$infiltervar1valuesnotnull),]
    }
#     if(input$infiltervar1=="None") {
#       df 
#       }
    
    
 df
})

  output$filtervar2 <- renderUI({
        df <- filedata()
            if (is.null(df)) return(NULL)
   NUNIQUEDF <- sapply(df, function(x) length(unique(x)))
   NAMESTOKEEP<- names(df)  [ NUNIQUEDF  < input$inmaxlevels ]
   NAMESTOKEEP<-  NAMESTOKEEP[ NAMESTOKEEP!=input$infiltervar1 ]

   selectInput("infiltervar2" , "Filter variable 2:",c('None',NAMESTOKEEP ) )
      })
  
     output$filtervar2values <- renderUI({
   df <- subsetdata()
      
   if (is.null(df)) return(NULL)
 if(input$infiltervar2=="None") {
   selectInput('infiltervar2valuesnull',
            label ='No filter variable 2 specified', 
             choices = list(""),multiple=TRUE, selectize=FALSE)   
                                }
 if(input$infiltervar2!="None"&!is.null(input$infiltervar2) )  {
choices <- levels(as.factor(as.character(df[,input$infiltervar2])))
selectInput('infiltervar2valuesnotnull',
label = paste("Select values", input$infiltervar2),
choices = c(choices),
selected = choices,
multiple=TRUE, selectize=TRUE)   
}
  })   
  
  subsetdata2  <- reactive({
      df <- subsetdata()
      if (is.null(df)) return(NULL)
    if(!is.null(input$infiltervar2)&input$infiltervar2!="None") {
      df <-  df [ is.element(df[,input$infiltervar2],input$infiltervar2valuesnotnull),]
    }
      if(input$infiltervar2=="None") {
      df 
      }
 df
})
  

output$catvar <- renderUI({
    df <-filedata()

    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
   MODEDF <- sapply(df, function(x) is.numeric(x))
   NAMESTOKEEP2<- names(df)  [ MODEDF ]
   selectInput('catvarin',label = 'Recode into Binned Categories:',choices=NAMESTOKEEP2,multiple=TRUE)
   
  })


output$ncuts <- renderUI({
    if (length(input$catvarin ) <1)  return(NULL)
   sliderInput('ncutsin',label = 'N of Cut Breaks:', min=2, max=10, value=c(3),step=1)
  })

     

output$catvar2 <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
   MODEDF <- sapply(df, function(x) is.numeric(x))
   NAMESTOKEEP2<- names(df)  [ MODEDF ]
    if (length(input$catvarin ) >=1) {
         NAMESTOKEEP2<-NAMESTOKEEP2 [ !is.element(NAMESTOKEEP2,input$catvarin) ]

    }
  
   selectInput('catvar2in',label = 'Treat as Categories:',choices=NAMESTOKEEP2,multiple=TRUE)
   
  })

  recodedata1  <- reactive({
      df <- subsetdata2()
      if (is.null(df)) return(NULL)
if(length(input$catvarin ) >=1) {
       for (i in 1:length(input$catvarin ) ) {
         varname<- input$catvarin[i]
       df[,varname] <- cut(df[,varname],input$ncutsin)
       df[,varname]   <- as.factor( df[,varname])
       }
}
 df
})
  
  
  recodedata2  <- reactive({
      df <- recodedata1()
      if (is.null(df)) return(NULL)
    if(length(input$catvar2in ) >=1) {
       for (i in 1:length(input$catvar2in ) ) {
         varname<- input$catvar2in[i]
       df[,varname]   <- as.factor( df[,varname])
       }
}
 df
})
  
output$colour <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("colorin", "Colour By:",c("None",items ) )
    
  })

output$group <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("groupin", "Group By:",c("None",items ) )
    
  })

output$facet_col <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("facetcolin", "Column Split:",c(None='.',items)
 )
    
    
    
  })
output$facet_row <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("facetrowin", "Row Split:",    c(None=".",items)
)
    
  })

output$pointsize <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("pointsizein", "Size By:",    c("None",items)
)
    
  })

output$fill <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("fillin", "Fill By:",    c("None",items)
)
    
  })

output$weight <- renderUI({
    df <-filedata()
    if (is.null(df)) return(NULL)
    items=names(df)
    names(items)=items
    selectInput("weightin", "Weight By:",    c("None",items)
)
    
  })



   output$mytablex = renderDataTable({
datatable(recodedata2() ,
          extensions = c('ColReorder','TableTools'),
          options = list(dom = 'RMD<"cvclear"C><"clear"T>lfrtip',
                         searchHighlight = TRUE,
                         pageLength=10 ,
                         lengthMenu = list(c(5, 10, 15, -1), c('5','10', '15', 'All')),
                         colReorder = list(realtime = TRUE),
                         tableTools = list(
    "sSwfPath" = "//cdnjs.cloudflare.com/ajax/libs/datatables-tabletools/2.1.5/swf/copy_csv_xls.swf",
    "aButtons" = list(
      "copy",
      "print",
      list("sExtends" = "collection",
           "sButtonText" = "Save",
           "aButtons" = c("csv","xls")
      )
    )
  )
                         ), 
          filter = 'bottom',
   style = "bootstrap")
})
    
 plotObject <- reactive({
      plotdata <- recodedata2()

      if(!is.null(plotdata)) {

      p <- ggplot(plotdata, aes_string(x=input$x, y=input$y)) 
      
      if (input$Points=="Points"&input$pointsizein == 'None')
        p <- p + geom_point(,alpha=input$pointstransparency,shape=input$pointtypes,size=input$pointsizes)  
        if (input$Points=="Points"&input$pointsizein != 'None')
        p <- p + geom_point(,alpha=input$pointstransparency,shape=input$pointtypes)  
        if (input$line=="Lines"&input$pointsizein == 'None')
        p <- p + geom_line(,size=input$linesize,alpha=input$linestransparency,linetype=input$linetypes)
        
        if (input$line=="Lines"&input$pointsizein != 'None')
        p <- p + geom_line(,alpha=input$linestransparency,linetype=input$linetypes)
          
      if (input$pointsizein != 'None')
        p <- p  + aes_string(size=input$pointsizein)
      
      if (input$Points=="Jitter")
        p <- p + geom_jitter()
      if (input$colorin != 'None')
           p <- p + aes_string(color=input$colorin)
      if (input$fillin != 'None')
           p <- p + aes_string(fill=input$fillin)
      
      if (input$groupin != 'None' & !is.factor(plotdata[,input$x]))
        p <- p + aes_string(group=input$groupin)
      
      if (input$groupin != 'None' & is.factor(plotdata[,input$x]))
        p <- p + aes(group=1)
         
###### Mean section  START 


if (!input$meanignoregroup) {
if (!input$meanignorecol) {
        
           if (input$Mean=="Mean") {
             if(input$meanlines)           
  p <- p + 
      stat_sum_single(mean, geom = "line")
  
                  if(input$meanpoints)           
p <- p + 
      stat_sum_single(mean, geom = "point")
             
           }
   
           if (input$Mean=="Mean (95% CI)"){
             p <- p + 
  stat_sum_df("mean_cl_normal", geom = "errorbar",width=input$errbar)
        if(input$meanlines)  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line",width=input$errbar)
   if(input$meanpoints)           
p <- p + 
      stat_sum_df("mean_cl_normal", geom = "point",width=input$errbar)
             
           }
       }


  if (input$meanignorecol) {
        meancol <- input$colmean
           if (input$Mean=="Mean") {
             if(input$meanlines)           
  p <- p + 
      stat_sum_single(mean, geom = "line",col=meancol)
  
                  if(input$meanpoints)           
p <- p + 
      stat_sum_single(mean, geom = "point",col=meancol)
             
           }
   
           if (input$Mean=="Mean (95% CI)"){
             p <- p + 
  stat_sum_df("mean_cl_normal", geom = "errorbar",width=input$errbar,col=meancol)
        if(input$meanlines)  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line",width=input$errbar,col=meancol)
   if(input$meanpoints)           
p <- p + 
      stat_sum_df("mean_cl_normal", geom = "point",width=input$errbar,col=meancol)
             
           }
       }
}

if (input$meanignoregroup) {
if (!input$meanignorecol) {
        
           if (input$Mean=="Mean") {
             if(input$meanlines)           
  p <- p + 
      stat_sum_single(mean, geom = "line",aes(group=NULL))
  
                  if(input$meanpoints)           
p <- p + 
      stat_sum_single(mean, geom = "point",aes(group=NULL))
             
           }
   
           if (input$Mean=="Mean (95% CI)"){
             p <- p + 
  stat_sum_df("mean_cl_normal", geom = "errorbar",width=input$errbar,aes(group=NULL))
        if(input$meanlines)  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line",width=input$errbar,aes(group=NULL))
   if(input$meanpoints)           
p <- p + 
      stat_sum_df("mean_cl_normal", geom = "point",width=input$errbar,aes(group=NULL))
             
           }
       }


  if (input$meanignorecol) {
        meancol <- input$colmean
           if (input$Mean=="Mean") {
             if(input$meanlines)           
  p <- p + 
      stat_sum_single(mean, geom = "line",col=meancol,aes(group=NULL))
  
                  if(input$meanpoints)           
p <- p + 
      stat_sum_single(mean, geom = "point",col=meancol,aes(group=NULL))
             
           }
   
           if (input$Mean=="Mean (95% CI)"){
             p <- p + 
  stat_sum_df("mean_cl_normal", geom = "errorbar",width=input$errbar,col=meancol,aes(group=NULL))
        if(input$meanlines)  
           p <- p + 
      stat_sum_df("mean_cl_normal", geom = "line",width=input$errbar,col=meancol,aes(group=NULL))
   if(input$meanpoints)           
p <- p + 
      stat_sum_df("mean_cl_normal", geom = "point",width=input$errbar,col=meancol,aes(group=NULL))
             
           }
       }
}
###### Mean section  END 

###### Loess Section START
if(!is.null(input$Loess) ){
  if ( input$ignoregroup) {
      if (!input$ignorecol) {
      spanplot <- input$loessens
      if (input$Loess=="Loess")
        p <- p + geom_smooth(method="loess",size=1.5,se=F,span=spanplot,aes(group=NULL))
      
      if (input$Loess=="Loess and SE")
        p <- p + geom_smooth(method="loess",size=1.5,se=T,span=spanplot,aes(group=NULL))
      
      if (input$Loess=="Loess"& input$weightin != 'None')
        p <- p + geom_smooth(method="loess",size=1.5,se=F,span=spanplot,aes(group=NULL))+  
        aes_string(weight=input$weightin)
      
      if (input$Loess=="Loess and SE"& input$weightin != 'None')
        p <- p + geom_smooth(method="loess",size=1.5,se=T,span=spanplot,aes(group=NULL))+  
        aes_string(weight=input$weightin)
      }
      if (input$ignorecol) {
        spanplot <- input$loessens
        colloeess <- input$colloess
      if (input$Loess=="Loess")
        p <- p + geom_smooth(method="loess",size=1.5,se=F,span=spanplot,col=colloeess,aes(group=NULL))
      
      if (input$Loess=="Loess and SE")
        p <- p + geom_smooth(method="loess",size=1.5,se=T,span=spanplot,col=colloeess,aes(group=NULL))
      
      if (input$Loess=="Loess"& input$weightin != 'None')
        p <- p + geom_smooth(method="loess",size=1.5,se=F,span=spanplot,col=colloeess,aes(group=NULL))+  
        aes_string(weight=input$weightin)
      
      if (input$Loess=="Loess and SE"& input$weightin != 'None')
        p <- p + geom_smooth(method="loess",size=1.5,se=T,span=spanplot,col=colloeess,aes(group=NULL))+  
        aes_string(weight=input$weightin)
              }
      
      }

      if ( !input$ignoregroup) {
      if (!input$ignorecol) {
      spanplot <- input$loessens
      if (input$Loess=="Loess")
        p <- p + geom_smooth(method="loess",size=1.5,se=F,span=spanplot)
      
      if (input$Loess=="Loess and SE")
        p <- p + geom_smooth(method="loess",size=1.5,se=T,span=spanplot)
      
      if (input$Loess=="Loess"& input$weightin != 'None')
        p <- p + geom_smooth(method="loess",size=1.5,se=F,span=spanplot)+  
        aes_string(weight=input$weightin)
      
      if (input$Loess=="Loess and SE"& input$weightin != 'None')
        p <- p + geom_smooth(method="loess",size=1.5,se=T,span=spanplot)+  
        aes_string(weight=input$weightin)
      }
      if (input$ignorecol) {
        spanplot <- input$loessens
        colloeess <- input$colloess
      if (input$Loess=="Loess")
        p <- p + geom_smooth(method="loess",size=1.5,se=F,span=spanplot,col=colloeess)
      
      if (input$Loess=="Loess and SE")
        p <- p + geom_smooth(method="loess",size=1.5,se=T,span=spanplot,col=colloeess)
      
      if (input$Loess=="Loess"& input$weightin != 'None')
        p <- p + geom_smooth(method="loess",size=1.5,se=F,span=spanplot,col=colloeess)+  
        aes_string(weight=input$weightin)
      
      if (input$Loess=="Loess and SE"& input$weightin != 'None')
        p <- p + geom_smooth(method="loess",size=1.5,se=T,span=spanplot,col=colloeess)+  
        aes_string(weight=input$weightin)
              }
      
      }

###### Loess Section END
}
      

###### Median PI section  START  
if (!input$medianignoregroup) {
  
      if (!input$medianignorecol) {
        
           if (input$Median=="Median") {
             if(input$medianlines)           
  p <- p + 
      stat_sum_single(median, geom = "line")
             
            if(input$medianlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",size=input$medianlinesize)
            
            
                  if(input$medianpoints)           
p <- p + 
      stat_sum_single(median, geom = "point")
             
           }
   
           if (input$Median=="Median/PI"&input$pointsizein == 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "smooth",conf.int=input$PI,size=input$medianlinesize,alpha=input$PItransparency)
             
             if ( input$sepguides )
           p <-   p + 
                guides(color = guide_legend(paste("Median ",toupper(input$y)),override.aes = list(shape =0 ,fill=NA)),
           fill = guide_legend(paste( 100*input$PI,"% prediction interval"),
                               override.aes = list(linetype =0 )
           ) )
           }

                   if (input$Median=="Median/PI"){
             p <- p + 
  stat_sum_df("median_hilow", geom = "smooth",conf.int=input$PI,alpha=input$PItransparency)
             
                      if ( input$sepguides )
           p <-   p + 
                guides(color = guide_legend(paste("Median",toupper(input$y)),override.aes = list(shape =0 ,fill=NA)),
           fill = guide_legend(paste( 100*input$PI,"% prediction interval"),
                               override.aes = list(linetype =0 )
           ) )
             
           }
               }



  if (input$medianignorecol) {
        mediancol <- input$colmedian
          if (input$Median=="Median") {
             if(input$medianlines)           
  p <- p + 
      stat_sum_single(median, geom = "line",col=mediancol)
        
          if(input$medianlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",col=mediancol,size=input$medianlinesize)
             
                  if(input$medianpoints)           
p <- p + 
      stat_sum_single(median, geom = "point",col=mediancol)
             
           }
   
           if (input$Median=="Median/PI"&input$pointsizein == 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "smooth",conf.int=input$PI,col=mediancol,size=input$medianlinesize,alpha=input$PItransparency)
                 if ( input$sepguides )
           p <-   p + 
                guides(color = guide_legend(paste("Median",toupper(input$y)),override.aes = list(shape =0 ,fill=NA)),
           fill = guide_legend(paste( 100*input$PI,"% prediction interval"),
                               override.aes = list(linetype =0 )
           ) )
           }
                 if (input$Median=="Median/PI"){
             p <- p + 
  stat_sum_df("median_hilow", geom = "smooth",conf.int=input$PI,col=mediancol,alpha=input$PItransparency)
                 if ( input$sepguides )
           p <-   p + 
                guides(color = guide_legend(paste("Median",toupper(input$y)),override.aes = list(shape =0 ,fill=NA)),
           fill = guide_legend(paste( 100*input$PI,"% prediction interval"),
                               override.aes = list(linetype =0 )
           ) )
           }
        
        
       }
}


if (input$medianignoregroup) {
  
      if (!input$medianignorecol) {
        
           if (input$Median=="Median") {
             if(input$medianlines)           
  p <- p + 
      stat_sum_single(median, geom = "line",aes(group=NULL))
               if(input$medianlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",aes(group=NULL),size=input$medianlinesize)
               
                  if(input$medianpoints)           
p <- p + 
      stat_sum_single(median, geom = "point",aes(group=NULL))
             
           }
   
           if (input$Median=="Median/PI"&input$pointsizein == 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "smooth",conf.int=input$PI,aes(group=NULL),size=input$medianlinesize,alpha=input$PItransparency)
                 if ( input$sepguides )
           p <-   p + 
                guides(color = guide_legend(paste("Median",toupper(input$y)),override.aes = list(shape =0 ,fill=NA)),
           fill = guide_legend(paste( 100*input$PI,"% prediction interval"),
                               override.aes = list(linetype =0 )
           ) )
           }
        
                 if (input$Median=="Median/PI"){
             p <- p + 
  stat_sum_df("median_hilow", geom = "smooth",conf.int=input$PI,aes(group=NULL),alpha=input$PItransparency)
                 if ( input$sepguides )
           p <-   p + 
                guides(color = guide_legend(paste("Median",toupper(input$y)),override.aes = list(shape =0 ,fill=NA)),
           fill = guide_legend(paste( 100*input$PI,"% prediction interval"),
                               override.aes = list(linetype =0 )
           ) )
           }
        
       }


  if (input$medianignorecol) {
        mediancol <- input$colmedian
          if (input$Median=="Median") {
             if(input$medianlines)           
  p <- p + 
      stat_sum_single(median, geom = "line",col=mediancol,aes(group=NULL))
             if(input$medianlines&input$pointsizein == 'None')           
  p <- p + 
      stat_sum_single(median, geom = "line",col=mediancol,aes(group=NULL),size=input$medianlinesize)
             
                  if(input$medianpoints)           
p <- p + 
      stat_sum_single(median, geom = "point",col=mediancol,aes(group=NULL))
             
           }
   
           if (input$Median=="Median/PI"&input$pointsizein == 'None'){
             p <- p + 
  stat_sum_df("median_hilow", geom = "smooth",conf.int=input$PI,col=mediancol,aes(group=NULL),size=input$medianlinesize,alpha=input$PItransparency)
                 if ( input$sepguides )
           p <-   p + 
                guides(color = guide_legend(paste("Median",toupper(input$y)),override.aes = list(shape =0 ,fill=NA)),
           fill = guide_legend(paste( 100*input$PI,"% prediction interval"),
                               override.aes = list(linetype =0 )
           ) )
           }
               if (input$Median=="Median/PI"){
             p <- p + 
  stat_sum_df("median_hilow", geom = "smooth",conf.int=input$PI,col=mediancol,aes(group=NULL),alpha=input$PItransparency)
                 if ( input$sepguides )
           p <-   p + 
                guides(color = guide_legend(paste("Median",toupper(input$y)),override.aes = list(shape =0 ,fill=NA)),
           fill = guide_legend(paste( 100*input$PI,"% prediction interval"),
                               override.aes = list(linetype =0 )
           ) )
               }
        
       }
}



###### Median PI section  END


###### RQSS SECTION START  
if (!input$ignoregroupqr) {
    if (!input$ignorecolqr) {
      if (input$Tauvalue) {
        if(!input$hidedynamic){
       p <- p +  stat_quantile(method = "rqss",quantiles =input$Tau,size=1.5,
                                  linetype="solid", 
                                  formula=y ~ qss(x, constraint= input$Constraints,
                                                  lambda=input$Penalty))       
        }

    if (input$mid)
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.5,size=1.5,
                              linetype="solid",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
    if (input$ninetieth)
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.90,size=1,
                              linetype="dashed",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
    if (input$tenth)
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.1,size=1,
                              linetype="dashed",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
    
    if (input$up)
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.95,size=1,
                              linetype="dashed",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
    
    if (input$low) 
      p <- p +  stat_quantile(method = "rqss",quantiles = 0.05,size=1,
                              linetype="dashed",
                              formula=y ~ qss(x, constraint= input$Constraints,
                                              lambda=input$Penalty))
      
    
    
    }
  }
   if (input$ignorecolqr) {
    colqr <- input$colqr
    if (input$Tauvalue) {
      if(!input$hidedynamic){
        p <- p +  stat_quantile(method = "rqss",quantiles =input$Tau,size=1.5,
                                linetype="solid", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty)) 
      }
      
      
      if (input$mid)
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.5,size=1.5,
                                linetype="solid", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      if (input$ninetieth)
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.90,size=1,
                                linetype="dashed", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      if (input$tenth)
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.1,size=1,
                                linetype="dashed", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      if (input$up)
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.95,size=1,
                                linetype="dashed", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      if (input$low) 
        p <- p +  stat_quantile(method = "rqss",quantiles = 0.05,size=1,
                                linetype="dashed", col=colqr,
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      
      
    }
  }
}


if (input$ignoregroupqr) {
  if (!input$ignorecolqr) {
   if (input$Tauvalue) {
     if(!input$hidedynamic){
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles =input$Tau,size=1.5,
                               linetype="solid",
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty)) 
     }
      
      if (input$mid)
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.5,size=1.5,
                                linetype="solid",
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      if (input$ninetieth)
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.90,size=1,
                                linetype="dashed", 
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      if (input$tenth)
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.1,size=1,
                                linetype="dashed",
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      if (input$up)
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.95,size=1,
                                linetype="dashed", 
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
      
      if (input$low) 
        p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.05,size=1,
                                linetype="dashed", 
                                formula=y ~ qss(x, constraint= input$Constraints,
                                                lambda=input$Penalty))
    }
  }
 if (input$ignorecolqr) {
   colqr <- input$colqr
   if (input$Tauvalue) {
     if(!input$hidedynamic){
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles =input$Tau,size=1.5,
                               linetype="solid",col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))     
     }
     

     if (input$mid)
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.5,size=1.5,
                               linetype="solid", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     if (input$ninetieth)
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.90,size=1,
                               linetype="dashed", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     if (input$tenth)
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.1,size=1,
                               linetype="dashed", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     
     if (input$up)
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.95,size=1,
                               linetype="dashed", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     
     if (input$low) 
       p <- p +  stat_quantile(aes(group=NULL),method = "rqss",quantiles = 0.05,size=1,
                               linetype="dashed", col=colqr,
                               formula=y ~ qss(x, constraint= input$Constraints,
                                               lambda=input$Penalty))
     
    }
  }
}


###### RQSS SECTION END


      facets <- paste(input$facetrowin, '~', input$facetcolin)
      if (facets != '. ~ .')
        p <- p + facet_grid(facets,scales=input$facetscales,space=input$facetspace)
      
           if (input$logy)
      p <- p + scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x))) 
      
       if (input$logx)
      p <- p + scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x))) 
      
      
      if (input$ylab!="")
      p <- p + ylab(input$ylab)
      
       if (input$xlab!="")
      p <- p + xlab(input$xlab)

if (input$horizontalzero)
  p <-    p+
  geom_hline(aes(yintercept=0))
      
       if (input$customline1)
   p <-    p+
   geom_vline(xintercept=input$vline)
      
      
      if (input$customline2)
  p <-    p+
  geom_hline(yintercept=input$hline)
      
      

if (input$identityline)
 p <-    p+ geom_abline(intercept = 0, slope = 1)

      if (input$themebw)
p <-    p+
      theme_bw()
 p <-    p+
    theme(
        legend.position=input$legendposition,
        panel.background = element_rect(fill=input$backgroundcol),
        axis.title.y = element_text(size = rel(1.5)),
        axis.title.x = element_text(size = rel(1.5)),
         strip.text.x = element_text(size = 16),
        strip.text.y = element_text(size = 16)
        )
       if (input$labelguides)
 p <-    p+
    theme(legend.title=element_blank())
if (input$themeaspect)
  p <-    p+
    theme(aspect.ratio=input$aspectratio)
 

p
    }
    })
    
    output$plot <- renderPlot({
      plotObject()
    })
    
    
    
    
    output$plotinfo <- renderPrint({
    df<- recodedata2()  
      if (is.null(df)) return(NULL)
          nearPoints( recodedata2(), input$plot_click, threshold = 5, maxpoints = 5,
               addDist = TRUE,xvar=input$x, yvar=input$y)
  })
    
    
    output$clickheader <-  renderUI({
  df <-recodedata2()
    if (is.null(df)) return(NULL)
   h4("Clicked points")
     })
  
        output$brushheader <-  renderUI({
  df <-recodedata2()
    if (is.null(df)) return(NULL)
     h4("Brushed points")

     })
    
        output$plot_clickedpoints <- renderTable({
      # For base graphics, we need to specify columns, though for ggplot2,
      # it's usually not necessary.
              df<- recodedata2()  
      if (is.null(df)) return(NULL)
              
      res <- nearPoints(recodedata2(), input$plot_click, input$x, input$y)
      if (nrow(res) == 0|is.null(res))
        return(NULL)
      res
    })
    output$plot_brushedpoints <- renderTable({
        df<- recodedata2()  
      if (is.null(df)) return(NULL)
      res <- brushedPoints(recodedata2(), input$plot_brush, input$x, input$y)
      if (nrow(res) == 0|is.null(res))
        return(NULL)
      res
    })
    
    
    
    
    downloadPlotType <- reactive({
      input$downloadPlotType  
    })
    
    observe({
      plotType    <- input$downloadPlotType
      plotTypePDF <- plotType == "pdf"
      plotUnit    <- ifelse(plotTypePDF, "inches", "pixels")
      plotUnitDef <- ifelse(plotTypePDF, 7, 480)
      
      updateNumericInput(
        session,
        inputId = "downloadPlotHeight",
        label = sprintf("Height (%s)", plotUnit),
        value = plotUnitDef)
      
      updateNumericInput(
        session,
        inputId = "downloadPlotWidth",
        label = sprintf("Width (%s)", plotUnit),
        value = plotUnitDef)
      
    })
    
    
    # Get the download dimensions.
    downloadPlotHeight <- reactive({
      input$downloadPlotHeight
    })
    
    downloadPlotWidth <- reactive({
      input$downloadPlotWidth
    })
    
    # Get the download file name.
    downloadPlotFileName <- reactive({
      input$downloadPlotFileName
    })
    
    # Include a downloadable file of the plot in the output list.
    output$downloadPlot <- downloadHandler(
      filename = function() {
        paste(downloadPlotFileName(), downloadPlotType(), sep=".")   
      },
      # The argument content below takes filename as a function
      # and returns what's printed to it.
      content = function(con) {
        # Gets the name of the function to use from the 
        # downloadFileType reactive element. Example:
        # returns function pdf() if downloadFileType == "pdf".
        plotFunction <- match.fun(downloadPlotType())
        plotFunction(con, width = downloadPlotWidth(), height = downloadPlotHeight())
        print(plotObject())
        dev.off(which=dev.cur())
      }
    )

    
  }

shinyApp(ui = ui, server = server,  options = list(height = 1000))

```
